apiVersion: kubevious.io/v1alpha1
kind: ClusterRule
metadata:
  name: pod-spec-volume-secret-ref
spec:
  target: |
    Shortcut("PodSpec")
  cache: |
    cache.secrets = 
      helpers.newNameLookupDict(
        ApiVersion('v1')
            .Kind("Secret")
            .many()
      );
  rule: |
    for(const volume of config.spec?.volumes ?? [])
    {
      if (volume.secret)
      {
        checkSecretRef(volume.name, volume.secret);
      }
      else if (volume.projected)
      {
        for(const source of volume.projected.sources)
        {
          if (source.secret)
          {
            checkSecretRef(volume.name, source.secret);
          }
        }
      }
    }

    function checkSecretRef(volumeName, secretRef)
    {
      const secretItem = cache.secrets.resolve(secretRef.name);
      if (!secretItem)
      {
        if (!secretRef.optional)
        {
          error(`Could not find Secret ${secretRef.name} referenced in volume ${volumeName}.`);
        }
      }
      else
      {
        if (secretRef.items)
        {
          const dataObj = secretItem.config.data ?? {};
          for(const item of secretRef.items)
          {
            if (!dataObj[item.key])
            {
              if (!secretRef.optional)
              {
                error(`Could not find data key ${item.key} in Secret ${secretRef.name} referenced in volume ${volumeName}.`);
              }
            }
          }
        }
      }
    }